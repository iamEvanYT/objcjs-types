# AGENTS.md

## Project Overview

`objcjs-types` is a standalone npm package providing auto-generated TypeScript type
declarations for macOS Objective-C frameworks (Foundation, AppKit, WebKit). Types are
generated by parsing Apple SDK headers via `clang -ast-dump=json`, then emitting `.ts`
declaration files. The generated output is committed to the repo.

## Build / Run Commands

| Command | Purpose |
|---------|---------|
| `bun run generate` | Regenerate all 181 class files from SDK headers (requires Xcode) |
| `bunx tsc --noEmit` | Typecheck the entire project (must pass with 0 errors) |
| `bun run index.ts` | Run the demo file (creates an NSWindow, requires macOS) |

There is no build/compile step — the package exports raw `.ts` files. There are no
tests or linter configured. Always use Bun, never Node/npm/npx.

## Project Structure

```
generator/           # Hand-written code generation pipeline (6 files)
src/                 # Generated output (DO NOT EDIT except structs.ts)
  structs.ts         # Hand-written struct interfaces + factory functions
  index.ts           # Auto-generated barrel (re-exports structs + frameworks)
  Foundation/        # 72 auto-generated class files + index.ts
  AppKit/            # 84 auto-generated class files + index.ts
  WebKit/            # 25 auto-generated class files + index.ts
index.ts             # Hand-written demo/example usage file
```

**Critical:** All files under `src/` except `src/structs.ts` are auto-generated and
marked with `// AUTO-GENERATED by objcjs-types generator — DO NOT EDIT`. Never edit
them directly — modify the generator instead and re-run `bun run generate`.

## TypeScript Configuration

Strict mode is enabled with these additional flags:
- `verbatimModuleSyntax: true` — must use `import type` for type-only imports
- `noUncheckedIndexedAccess: true` — indexed access returns `T | undefined`
- `noImplicitOverride: true` — subclass overrides require `override` keyword
- `allowImportingTsExtensions: true` — `.ts` extensions allowed in import paths
- `moduleResolution: "bundler"` / `module: "Preserve"`

## Code Style

### Formatting
- 2-space indentation
- Double quotes for strings
- Semicolons always
- Trailing commas in multi-line constructs

### Imports
- Use `import type` for type-only imports (enforced by `verbatimModuleSyntax`)
- **Generator files** (hand-written): use `.ts` extensions (`"./frameworks.ts"`)
- **Generated output files**: use `.js` extensions (`"./NSButton.js"`, `"../structs.js"`)
- Import order: Node.js built-ins first, then local modules
- No default exports anywhere — use named exports exclusively

### Naming Conventions
- **Interfaces/Types:** PascalCase (`ObjCClass`, `FrameworkConfig`, `ClangASTNode`)
- **Functions:** camelCase (`parseAST`, `mapReturnType`, `emitClassFile`)
- **Lookup-table constants:** UPPER_SNAKE_CASE (`NUMERIC_TYPES`, `STRUCT_TYPE_MAP`,
  `SHARED_HEADERS`, `SDK_PATH`)
- **Local variables:** camelCase (`headerCount`, `allKnownClasses`)
- **Generated class types:** `_ClassName` with underscore prefix (`_NSObject`,
  `_NSWindow`) — distinguishes the declaration type from the runtime const
- **Struct dual declarations:** Same name for interface and factory function
  (`CGPoint` the type, `CGPoint()` the function — TypeScript allows this)

### Comments
- JSDoc `/** ... */` on all exported functions and module-level descriptions
- Inline `//` comments for non-obvious logic
- Section headers with `// ---` separators in structs.ts

## Key Type Patterns

### Generated class files
Each class file follows this structure:
1. Auto-generated header comment
2. `import type { NobjcObject } from "objc-js";`
3. Type imports for referenced classes (same-framework, then cross-framework)
4. Type imports for referenced structs from `"../structs.js"`
5. `export declare class _ClassName extends _SuperClass { ... }`
6. `alloc()`/`new()`/`init()` overrides returning the subclass type
7. Class methods (static), instance methods, then properties sections

### Framework index files
```ts
import type { _NSWindow } from "./NSWindow.js";
export const NSWindow = AppKit["NSWindow"] as unknown as typeof _NSWindow;
export type { _NSWindow };
```
The `as unknown as typeof` double-cast bridges runtime `NobjcLibrary` lookups to the
generated type declarations.

### Struct types
Dual interface+function pattern in `src/structs.ts`:
```ts
export interface CGRect { origin: CGPoint; size: CGSize; }
export function CGRect(x: number, y: number, width: number, height: number): CGRect {
  return { origin: { x, y }, size: { width, height } };
}
```
NS aliases use type+const: `export type NSRect = CGRect; export const NSRect = CGRect;`

### ObjC method naming
Selectors use the `$` convention: `initWithContentRect:styleMask:` becomes
`initWithContentRect$styleMask$`. Properties emit getter methods (`title(): _NSString`)
and setter methods for readwrite properties (`setTitle$(value: _NSString): void`).

## Error Handling

- Generator top-level: `main().catch(err => { console.error(...); process.exit(1); })`
- Per-header: try/catch logs errors but continues generation for remaining headers
- Missing headers: logged and skipped gracefully
- Clang failures: fallback retry without `-fmodules` using Foundation pre-includes
- Demo file: explicit `throw new Error(...)` for runtime null checks

## Generator Pipeline

The pipeline runs per-header for each framework:

1. **clang.ts** — Runs `clang -Xclang -ast-dump=json` via `Bun.spawn`, parses JSON
2. **ast-parser.ts** — Walks AST nodes, extracts `ObjCClass` with methods/properties
3. **type-mapper.ts** — Maps ObjC `qualType` strings to TypeScript types using
   `STRUCT_TYPE_MAP`, `DIRECT_MAPPINGS`, `NUMERIC_TYPES`, framework class name sets,
   and enum/block heuristics. Fallback type is `NobjcObject`.
4. **emitter.ts** — Generates `.ts` files with proper imports, class hierarchy, method
   signatures, struct imports, and framework barrel exports

Key considerations:
- Process individual headers (not umbrella headers — too large)
- Some classes share headers (see `SHARED_HEADERS` in `frameworks.ts`)
- `instancetype` returns require overrides on every subclass
- Override conflicts resolved by skipping child methods that return `NobjcObject` when
  the parent has a more specific type

## Cursor Rules

Always use Bun instead of Node.js/npm/npx/pnpm. Use `bun run`, `bun test`,
`bun install`, `bunx`. Prefer Bun-specific APIs (`Bun.spawn`, `Bun.file`, etc.) over
Node.js equivalents.
