# AGENTS.md

## Project Overview

`objcjs-types` is a standalone npm package providing auto-generated TypeScript type
declarations for all macOS Objective-C frameworks. Types are generated by parsing Apple
SDK headers via `clang -ast-dump=json`, then emitting `.ts` declaration files. The
generated output (~5400 classes, ~1000 protocols, ~2600 enums across ~150 frameworks)
is committed to the repo.

## Build / Run Commands

| Command                              | Purpose                                                                   |
| ------------------------------------ | ------------------------------------------------------------------------- |
| `bun run generate`                   | Regenerate all type files from SDK headers (requires Xcode, ~50s)         |
| `bun run generate Foundation AppKit` | Regenerate specific frameworks only                                       |
| `bunx tsgo --noEmit`                 | Typecheck the entire project (36 pre-existing errors in generated output) |
| `bun run tests/window.ts`            | Run a test file (requires macOS with GUI)                                 |

There is no build step — the package exports raw `.ts` files. There is no test runner
or linter configured; tests are manual `bun run tests/*.ts` scripts. Always use Bun,
never Node/npm/npx/pnpm.

## Project Structure

```
generator/              # Hand-written generation pipeline (11 source files)
  index.ts              #   Main orchestrator (phases 1-4, CLI entry point)
  frameworks.ts         #   SDK framework discovery, EXTRA_HEADERS, PRE_INCLUDES
  discover.ts           #   Regex-scans .h files for class/protocol/enum names
  clang.ts              #   Clang invocation (single, pre-includes, batch modes)
  ast-parser.ts         #   Walks clang AST JSON, extracts classes/protocols/enums/structs
  type-mapper.ts        #   Maps ObjC qualType strings to TypeScript types
  emitter.ts            #   Generates .ts declaration files from parsed data
  worker-pool.ts        #   Fixed-size thread pool with work-stealing dispatch
  parse-worker.ts       #   Worker thread: runs clang + AST parsing per batch
  resolve-strings.ts    #   Resolves extern NSString* values from framework binaries
  struct-fields.ts      #   Parses runtime KNOWN_STRUCT_FIELDS for named fields
  templates/            #   Static .ts files copied verbatim into src/ during generation
src/                    # Generated output — DO NOT EDIT (modify generator instead)
  index.ts              #   Auto-generated barrel re-export
  delegates.ts          #   Auto-generated ProtocolMap + createDelegate helper
  structs/              #   Auto-generated struct files (108 files + index.ts)
  Foundation/           #   ~500 auto-generated files + index.ts
  AppKit/               #   ~850 auto-generated files + index.ts
  WebKit/               #   ... and ~150 more framework directories
  data.ts, helpers.ts, osversion.ts  # Copied from generator/templates/
tests/                  # Manual test/demo scripts (run with `bun run tests/*.ts`)
design/                 # Design documents
```

**Critical:** All files under `src/` are auto-generated or template-copied and marked
with `// AUTO-GENERATED`. Never edit them directly — modify the generator or its
templates instead and re-run `bun run generate`.

## TypeScript Configuration

Strict mode with these notable flags:

- `verbatimModuleSyntax` — must use `import type` for type-only imports
- `noUncheckedIndexedAccess` — indexed access returns `T | undefined`
- `noImplicitOverride` — subclass overrides require `override` keyword
- `allowImportingTsExtensions` — `.ts` extensions in imports
- `moduleResolution: "bundler"` / `module: "Preserve"`
- `noEmit: true` — no compilation output, raw `.ts` exports

## Code Style

### Formatting

- 2-space indentation, double quotes, semicolons always
- Trailing commas in multi-line constructs

### Imports

- Use `import type` for type-only imports (enforced by `verbatimModuleSyntax`)
- **Generator files** (hand-written): use `.ts` extensions (`"./frameworks.ts"`)
- **Generated output files**: use `.js` extensions (`"./NSButton.js"`, `"../structs.js"`)
- Order: Node.js built-ins first, then local modules
- Named exports only — no default exports anywhere

### Naming Conventions

- **Interfaces/Types:** PascalCase (`ObjCClass`, `FrameworkConfig`, `ClangASTNode`)
- **Functions:** camelCase (`parseAST`, `mapReturnType`, `emitClassFile`)
- **Lookup-table constants:** UPPER_SNAKE_CASE (`NUMERIC_TYPES`, `STRUCT_TYPE_MAP`)
- **Local variables:** camelCase (`headerCount`, `allKnownClasses`)
- **Generated class types:** underscore prefix `_ClassName` (`_NSObject`, `_NSWindow`)
- **Struct dual declarations:** same name for interface and factory (`CGPoint` type + `CGPoint()` function)

### Comments

- JSDoc `/** ... */` on all exported functions and module-level descriptions
- Inline `//` comments for non-obvious logic
- Section headers with `// ---` separators

## Key Type Patterns

### Generated class files

```ts
import type { NobjcObject } from "objc-js";
import type { _NSResponder } from "./NSResponder.js";
export declare class _NSWindow extends _NSResponder { ... }
```

Structure: auto-generated header, objc-js import, type imports for referenced
classes/structs, `export declare class` with alloc/new/init overrides, static methods,
instance methods, properties.

### Framework index files

```ts
export const NSWindow = AppKit["NSWindow"] as unknown as typeof _NSWindow;
export type { _NSWindow };
```

### ObjC method naming

Selectors use `$`: `initWithContentRect:styleMask:` becomes
`initWithContentRect$styleMask$`. Properties emit getters (`title(): _NSString`) and
setters for readwrite (`setTitle$(value: _NSString): void`).

## Error Handling

- Generator top-level: `main().catch(err => { console.error(...); process.exit(1); })`
- Per-header: try/catch logs errors but continues for remaining headers
- Missing headers: logged with `[SKIP]` and skipped
- Clang failures: fallback retry without `-fmodules` using Foundation pre-includes
- Test files: explicit `throw new Error(...)` for runtime null checks

## Generator Pipeline

The pipeline runs in 4 phases using a worker pool (8 threads):

1. **Discovery** — `frameworks.ts` + `discover.ts` scan SDK headers for names
2. **Task Building** — groups all headers per framework into batch tasks (~153 batches)
3. **Parallel Parsing** — worker pool dispatches batches:
   - `clang.ts` runs `clang -ast-dump=json` via `Bun.spawn`
   - `JSON.parse()` + `pruneAST()` filters to relevant AST node kinds
   - `ast-parser.ts` extracts classes, protocols, integer enums, string enums, structs
4. **Emission** — `type-mapper.ts` maps ObjC types to TS; `emitter.ts` writes `.ts` files

Key considerations:

- Batched clang (all framework headers in one invocation) without `-fmodules`
- `instancetype` returns require `alloc`/`new`/`init` overrides on every subclass
- Override conflicts: skip child methods returning `NobjcObject` when parent is more specific
- String enum values resolved by compiling + running a small ObjC helper binary

## Cursor Rules

Always use Bun instead of Node.js/npm/npx/pnpm:

- `bun run`, `bun test`, `bun install`, `bunx`
- Prefer `Bun.spawn`, `Bun.file`, `Bun.write` over Node.js equivalents
